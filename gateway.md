网关无状态

反向路由
安全认证
限流熔断
日志监控

传统反向代理静态配置不灵活，缺乏动态配置能力
运维配置能力低下

apigateway
bff
microservices

cqrs

http2
yapi
cap
canel

Host -> Service -> HttpClient
request interceptor -> lb -> response interceptor


go-kit
go-zero
kratos


限流熔断
动态路由和负载均衡
拦截器链
日志采集和 metrics 埋点
响应流优化


canal


一致的这个问题, 那就是个复杂问题了.  有以下等方法.
最大努力通知型: 基于唯一 id 号当场重试, 重试多次后失败. 提供接口查询, 校对.
TCC: 用户根据自己的业务场景实现 Try、Confirm 和 Cancel 三个操作；事务发起方在一阶段执行 Try 方式，在二阶段提交执行 Confirm 方法，二阶段回滚执行 Cancel 方法。
本地消息表: 本地事务与本地消息数据表一起插入, 由定时任务发送消息表中的数据到队列中.
事务消息:  本地事务的执行与消息发出去具有一致性, 有专门的事务消息中间件支持, 比如 rocketmq, 其实是上面本地消息表的一种演进.


不同得服务发现中间件在细节上都有细微差异，从性价比上来讲但是都围绕着 AP 理论。参考 lesson2 中 eueka 中实现，consumer-side 会在启动时向服务发现中心订阅 Provider-side 连接信息，为了避免过于频繁得向中心请求压力，选择了 30s 长连接得 patch 方式打包这段时间得更新信息，这样平滑了拉取压力，同时有 heath check 帮助下保证可用（同时也可选不同的 poll-period 来避免错峰 ）




直接对外暴露微服务，缺乏统一的出口：
客户端到微服务直接通信，强耦合。
需要多次请求，客户端聚合数据，工作量巨大，延迟高。
协议不利于统一，各个部门间有差异，需要端来兼容。
面向“端”的API适配，耦合到了内部服务。
多终端兼容逻辑复杂，每个服务都需要处理。
统一逻辑无法收敛，比如安全认证、限流


新增了一个网关服务用于统一的协议出口，在服务内进行聚合操作，给后续服务的演进带来的很多优势：
轻量交互：协议精简、聚合。
差异服务：数据裁剪以及聚合、针对终端定制化API。
动态升级：原有系统兼容升级，更新服务而非协议。
沟通效率提升，协作模式演进为移动业务+网关小组

整个 app-interface 属于 single point of failure，严重代码缺陷或者流量洪峰可能引发集群宕机
单个模块也会导致后续业务集成复杂度高
很多跨横切面逻辑，比如安全认证，日志监控，限流熔断等。随着时间的推移，代码变得越来越复杂，技术债越堆越多


引入了 API Gateway，把业务集成度高的 BFF 层和通用功能服务层 API Gateway 进行了分层处理
在网关的配合下，单块 BFF 实现了解耦拆分，各业务线团队可以独立开发和交付各自的微服务，研发效率大大提升。另外，把跨横切面逻辑从 BFF 剥离到网关上去以后，BFF 的开发人员可以更加专注业务逻辑交付


通常在 API Gateway 进行统一的认证拦截，一旦认证成功，我们会使用 JWT 方式通过 RPC 元数据传递的方式带到 BFF 层，BFF 校验 Token 完整性后把身份信息注入到应用的 Context 中，BFF 到其他下层的微服务，建议是直接在 RPC Request 中带入用户身份信息(UserID)请求服务



